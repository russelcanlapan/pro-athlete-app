<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registering Account Loading athlete</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        .basketball-animation {
            animation: bounce 1s infinite;
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-50">
    <div class="min-h-screen flex items-center justify-center">
        <div class="w-full max-w-md mx-auto px-6 py-8 text-center">
            <!-- Basketball Animation -->
            <div class="mb-8">
                <div class="w-32 h-32 mx-auto mb-6">
                    <div class="w-full h-full bg-orange-100 rounded-full flex items-center justify-center basketball-animation">
                        <div class="text-8xl">üèÄ</div>
                    </div>
                </div>
            </div>

            <!-- Loading Text -->
            <div class="mb-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-4">
                    Just a moment as we register your account...
                </h2>
            </div>
        </div>
    </div>

    <script>
        async function registerAthlete() {
            try {
                // Validate activation code first
                const activationKey = localStorage.getItem('activationKey');
                if (!activationKey) {
                    throw new Error('No activation key provided');
                }
                
                // Check if activation code is valid
                const isValidCode = await validateActivationCode(activationKey);
                if (!isValidCode) {
                    throw new Error('Invalid or expired activation code');
                }
                
                // Get signup data from both sessionStorage and localStorage
                const signupData = JSON.parse(sessionStorage.getItem('signupData') || '{}');
                const firstName = localStorage.getItem('signupFirstName') || signupData.firstName || 'Athlete';
                const lastName = localStorage.getItem('signupLastName') || signupData.lastName || 'User';
                const email = localStorage.getItem('signupEmail') || signupData.email || 'athlete@proathlete.com';
                
                // Get detailed profile data
                const profileData = JSON.parse(localStorage.getItem('athleteProfileData') || '{}');
                
                // Create user data with complete profile information
                const userData = {
                    id: 'athlete_' + Date.now(),
                    firstName: firstName,
                    lastName: lastName,
                    accountType: 'athlete',
                    email: email,
                    activationCode: activationKey,
                    createdAt: new Date(),
                    updatedAt: new Date(),
                    isActive: true,
                    isAuthenticated: true,
                    // Profile data from athlete profile form
                    sport: profileData.sport || '',
                    position: profileData.position || '',
                    height: profileData.height || '',
                    weight: profileData.weight || '',
                    dateOfBirth: profileData.dateOfBirth || '',
                    skillLevel: profileData.skillLevel || '',
                    teamName: profileData.teamName || '',
                    phone: profileData.phone || '',
                    goals: profileData.goals || []
                };
                
                console.log('Signup data available:', signupData);
                console.log('LocalStorage firstName:', localStorage.getItem('signupFirstName'));
                console.log('LocalStorage lastName:', localStorage.getItem('signupLastName'));
                console.log('Using activation code:', activationKey);
                console.log('Creating user with data:', userData);
                
                console.log('Registering athlete:', userData);
                
                // Mark activation code as used
                await markActivationCodeAsUsed(activationKey, userData);
                
                // Save user data to localStorage
                localStorage.setItem('currentUser', JSON.stringify(userData));
                localStorage.setItem('isAuthenticated', 'true');
                localStorage.setItem('userType', 'athlete');
                sessionStorage.setItem('athleteUserData', JSON.stringify(userData));
                
                // Clear signup data
                sessionStorage.removeItem('signupData');
                
                console.log('Athlete successfully registered!');
                
                // Navigate to success page
                setTimeout(() => {
                    window.location.href = 'account-success.html?t=' + Date.now();
                }, 2000);
                
            } catch (error) {
                console.error('Registration failed:', error);
                
                // Display appropriate error message
                let errorMessage = 'Registration failed. Please try again.';
                if (error.message.includes('activation')) {
                    errorMessage = 'Invalid activation code. Please check your code and try again.';
                }
                
                document.querySelector('.status-text').textContent = errorMessage;
                document.querySelector('.loading-spinner').style.display = 'none';
                
                // Redirect back to activation key page if code issue, otherwise success for demo
                setTimeout(() => {
                    if (error.message.includes('activation')) {
                        window.location.href = 'activation-key.html';
                    } else {
                        window.location.href = 'account-success.html?t=' + Date.now();
                    }
                }, 3000);
            }
        }

        // Validate activation code
        async function validateActivationCode(code) {
            try {
                const activationCodes = JSON.parse(localStorage.getItem('activationCodes') || '[]');
                const activationCode = activationCodes.find(ac => ac.code === code && ac.isActive);
                
                if (!activationCode) {
                    console.log('Activation code not found:', code);
                    return false;
                }
                
                // Check if code is expired
                if (activationCode.expiresAt && new Date() > new Date(activationCode.expiresAt)) {
                    console.log('Activation code expired:', code);
                    return false;
                }
                
                // Check if code has reached usage limit
                if (activationCode.usageLimit > 0 && activationCode.usageCount >= activationCode.usageLimit) {
                    console.log('Activation code usage limit exceeded:', code);
                    return false;
                }
                
                // Check if code is for athletes
                if (activationCode.type !== 'athlete') {
                    console.log('Activation code not for athletes:', code);
                    return false;
                }
                
                console.log('Activation code is valid:', code);
                return true;
            } catch (error) {
                console.error('Error validating activation code:', error);
                return false;
            }
        }

        // Mark activation code as used
        async function markActivationCodeAsUsed(code, userData) {
            try {
                const activationCodes = JSON.parse(localStorage.getItem('activationCodes') || '[]');
                const codeIndex = activationCodes.findIndex(ac => ac.code === code);
                
                if (codeIndex !== -1) {
                    activationCodes[codeIndex].usageCount++;
                    if (!activationCodes[codeIndex].usedBy) {
                        activationCodes[codeIndex].usedBy = [];
                    }
                    activationCodes[codeIndex].usedBy.push({
                        userName: `${userData.firstName} ${userData.lastName}`,
                        userEmail: userData.email,
                        userId: userData.id,
                        usedAt: new Date().toISOString()
                    });
                    
                    // Deactivate if single use
                    if (activationCodes[codeIndex].usageLimit === 1) {
                        activationCodes[codeIndex].isActive = false;
                    }
                    
                    localStorage.setItem('activationCodes', JSON.stringify(activationCodes));
                    console.log('Marked activation code as used:', code);
                }
            } catch (error) {
                console.error('Error marking activation code as used:', error);
            }
        }
        
        // Start registration process
        registerAthlete();
    </script>
</body>
</html>
