<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Accounts - Admin - Pro Athlete</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-gray-900">User Accounts</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-600">Welcome, <span id="adminUsername">root</span></span>
                    <button onclick="logout()" class="text-sm text-red-600 hover:text-red-700">Logout</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="bg-blue-600 text-white">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex space-x-8">
                <a href="dashboard.html" class="hover:bg-blue-700 px-3 py-2 text-sm font-medium">Dashboard</a>
                <a href="users.html" class="bg-blue-700 px-3 py-2 text-sm font-medium">User Accounts</a>
                <a href="reports.html" class="hover:bg-blue-700 px-3 py-2 text-sm font-medium">Reports</a>
                <a href="videos.html" class="hover:bg-blue-700 px-3 py-2 text-sm font-medium">Video Upload</a>
                <a href="activation-codes.html" class="hover:bg-blue-700 px-3 py-2 text-sm font-medium">Activation Codes</a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <!-- Filters -->
        <div class="bg-white shadow rounded-lg mb-6">
            <div class="px-4 py-5 sm:p-6">
                <div class="flex flex-wrap gap-4 items-center">
                    <div>
                        <label for="userTypeFilter" class="block text-sm font-medium text-gray-700">Filter by Type</label>
                        <select id="userTypeFilter" onchange="filterUsers()" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                            <option value="all">All Users</option>
                            <option value="athlete">Athletes</option>
                            <option value="coach">Coaches</option>
                        </select>
                    </div>
                    <div>
                        <label for="searchInput" class="block text-sm font-medium text-gray-700">Search Users</label>
                        <input type="text" id="searchInput" onkeyup="searchUsers()" placeholder="Search by name or email..." class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>
                    <div class="flex-1"></div>
                    <div>
                        <button onclick="refreshUsers()" class="bg-blue-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-blue-700">Refresh</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Users Table -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-4 py-5 sm:p-6">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sport</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Team</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTable" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="7" class="px-6 py-4 text-center text-gray-500">Loading users...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- User Details Modal -->
    <div id="userModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-96 overflow-y-auto">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">User Details</h3>
                <button onclick="closeUserModal()" class="float-right text-gray-400 hover:text-gray-600">
                    <span class="sr-only">Close</span>
                    <span class="text-2xl">&times;</span>
                </button>
            </div>
            <div id="userModalContent" class="px-6 py-4">
                <!-- User details will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        let allUsers = [];

        // Check admin authentication
        function checkAdminAuth() {
            if (sessionStorage.getItem('adminAuthenticated') !== 'true') {
                window.location.href = 'login.html';
                return false;
            }
            return true;
        }

        function logout() {
            sessionStorage.removeItem('adminAuthenticated');
            sessionStorage.removeItem('adminUsername');
            window.location.href = 'login.html';
        }

        // Load users from localStorage
        async function loadUsers() {
            try {
                // Get all registered users from multiple storage locations
                const allUserData = [];
                
                // Primary source: registeredUsers in localStorage
                const registeredUsers = JSON.parse(localStorage.getItem('registeredUsers') || '[]');
                console.log('Registered users from localStorage:', registeredUsers);
                allUserData.push(...registeredUsers);
                
                // Secondary source: users array in localStorage  
                const usersArray = JSON.parse(localStorage.getItem('users') || '[]');
                console.log('Users array from localStorage:', usersArray);
                allUserData.push(...usersArray);
                
                // Ensure Alexander Foronda is in the system (restore if missing)
                const alexanderExists = allUserData.some(user => 
                    user.email === 'alexforonda2000@gmail.com' || 
                    (user.firstName === 'Alexander' && user.lastName === 'Foronda')
                );
                
                if (!alexanderExists) {
                    console.log('Alexander Foronda missing, restoring...');
                    const alexanderData = {
                        id: 'athlete_1756914949651',
                        firstName: 'Alexander',
                        lastName: 'Foronda',
                        email: 'alexforonda2000@gmail.com',
                        accountType: 'athlete',
                        profile: {
                            firstName: 'Alexander',
                            lastName: 'Foronda',
                            email: 'alexforonda2000@gmail.com',
                            userType: 'athlete',
                            sport: '',
                            position: '',
                            height: '',
                            weight: '',
                            skillLevel: '',
                            teamName: '',
                            phone: '',
                            goals: []
                        },
                        activationCode: 'OEYGA2WX',
                        createdAt: '2025-09-03T15:55:49.651Z',
                        updatedAt: '2025-09-03T15:55:49.651Z',
                        isActive: true
                    };
                    
                    // Add to registeredUsers
                    registeredUsers.push(alexanderData);
                    localStorage.setItem('registeredUsers', JSON.stringify(registeredUsers));
                    
                    // Add to users array
                    usersArray.push(alexanderData);
                    localStorage.setItem('users', JSON.stringify(usersArray));
                    
                    allUserData.push(alexanderData);
                    console.log('Alexander Foronda restored to system');
                }
                
                // Check for users in other storage locations for backward compatibility
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && (key.includes('UserData') || key === 'currentUser')) {
                        try {
                            const userData = JSON.parse(localStorage.getItem(key));
                            if (userData && userData.email && userData.accountType) {
                                // Make sure we have proper user data structure
                                const normalizedUser = {
                                    id: userData.id || key,
                                    firstName: userData.firstName || 'Unknown',
                                    lastName: userData.lastName || 'User',
                                    email: userData.email,
                                    accountType: userData.accountType,
                                    createdAt: userData.createdAt || new Date().toISOString(),
                                    updatedAt: userData.updatedAt || new Date().toISOString(),
                                    isActive: userData.isActive !== false,
                                    activationCode: userData.activationCode || 'N/A',
                                    // Additional fields for user details
                                    phone: userData.phone || '',
                                    dateOfBirth: userData.dateOfBirth || '',
                                    sport: userData.sport || '',
                                    position: userData.position || '',
                                    height: userData.height || '',
                                    weight: userData.weight || '',
                                    skillLevel: userData.skillLevel || '',
                                    teamName: userData.teamName || '',
                                    organization: userData.organization || '',
                                    coachingExperience: userData.coachingExperience || ''
                                };
                                allUserData.push(normalizedUser);
                            }
                        } catch (e) {
                            // Skip invalid data
                            console.log('Skipping invalid user data:', key, e);
                        }
                    }
                }

                // Remove duplicates based on email
                allUsers = allUserData.filter((user, index, self) => 
                    index === self.findIndex(u => u.email === user.email)
                );

                console.log('Loaded users for admin panel:', allUsers);
                displayUsers(allUsers);
            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('usersTable').innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-red-500">Error loading users</td></tr>';
            }
        }

        function displayUsers(users) {
            const usersTable = document.getElementById('usersTable');
            
            if (users.length === 0) {
                usersTable.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">No users found</td></tr>';
                return;
            }

            usersTable.innerHTML = users.map(user => `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${user.firstName} ${user.lastName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.email}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${user.accountType === 'athlete' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}">
                            ${user.accountType}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.sport || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.teamName || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(user.createdAt).toLocaleDateString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="viewUserDetails('${user.id}')" class="text-blue-600 hover:text-blue-900">View Details</button>
                    </td>
                </tr>
            `).join('');
        }

        function filterUsers() {
            const filterType = document.getElementById('userTypeFilter').value;
            let filteredUsers = allUsers;

            if (filterType !== 'all') {
                filteredUsers = allUsers.filter(user => user.accountType === filterType);
            }

            displayUsers(filteredUsers);
        }

        function searchUsers() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filteredUsers = allUsers.filter(user => 
                user.firstName.toLowerCase().includes(searchTerm) ||
                user.lastName.toLowerCase().includes(searchTerm) ||
                user.email.toLowerCase().includes(searchTerm)
            );

            displayUsers(filteredUsers);
        }

        function refreshUsers() {
            loadUsers();
        }

        function viewUserDetails(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;

            // Get all available user data sources
            const registeredUsers = JSON.parse(localStorage.getItem('registeredUsers') || '[]');
            const sessionUsers = JSON.parse(sessionStorage.getItem('athleteUserData') || '{}');
            const profileData = user.profile || {};
            
            // Find user in all possible data sources
            const signupData = registeredUsers.find(u => u.id === userId || u.email === user.email) || {};
            const sessionData = sessionUsers.id === userId ? sessionUsers : {};
            
            console.log('Loading user data from sources:', { user, signupData, sessionData, profileData });
            
            // Merge all available data with priority: signupData > sessionData > profileData > user
            const fullUserData = { 
                ...user, 
                ...profileData, 
                ...sessionData.profile, 
                ...sessionData,
                ...signupData,
                // Ensure we have the activation code
                activationCode: signupData.activationCode || user.activationCode || 'N/A',
                // Ensure athletic information from profile is included
                sport: signupData.sport || sessionData.profile?.sport || profileData.sport || user.sport || '',
                position: signupData.position || sessionData.profile?.position || profileData.position || user.position || '',
                height: signupData.height || sessionData.profile?.height || profileData.height || user.height || '',
                weight: signupData.weight || sessionData.profile?.weight || profileData.weight || user.weight || '',
                skillLevel: signupData.skillLevel || sessionData.profile?.skillLevel || profileData.skillLevel || user.skillLevel || '',
                teamName: signupData.teamName || sessionData.profile?.teamName || profileData.teamName || user.teamName || '',
                goals: signupData.goals || sessionData.profile?.goals || profileData.goals || user.goals || []
            };
            
            const currentAdmin = sessionStorage.getItem('adminUsername');
            const isRootUser = currentAdmin === 'root';

            const modalContent = document.getElementById('userModalContent');
            modalContent.innerHTML = `
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <h4 class="font-medium text-gray-900 mb-2">Basic Information</h4>
                        <p><strong>Name:</strong> 
                            <span onclick="editField('${userId}', 'firstName', '${fullUserData.firstName}')" class="cursor-pointer hover:bg-gray-100 px-1 rounded">${fullUserData.firstName}</span>
                            <span onclick="editField('${userId}', 'lastName', '${fullUserData.lastName}')" class="cursor-pointer hover:bg-gray-100 px-1 rounded">${fullUserData.lastName}</span>
                        </p>
                        <p><strong>Email:</strong> 
                            <span onclick="editField('${userId}', 'email', '${fullUserData.email}')" class="cursor-pointer hover:bg-gray-100 px-1 rounded">${fullUserData.email}</span>
                        </p>
                        <p><strong>Account Type:</strong> ${fullUserData.accountType || fullUserData.userType}</p>
                        <p><strong>Phone:</strong> 
                            <span onclick="editField('${userId}', 'phone', '${fullUserData.phone || ''}')" class="cursor-pointer hover:bg-gray-100 px-1 rounded">${fullUserData.phone || 'Click to add'}</span>
                        </p>
                        <p><strong>Date of Birth:</strong> 
                            <span onclick="editField('${userId}', 'dateOfBirth', '${fullUserData.dateOfBirth || ''}')" class="cursor-pointer hover:bg-gray-100 px-1 rounded">${fullUserData.dateOfBirth || 'Click to add'}</span>
                        </p>
                        <p><strong>Team:</strong> 
                            <span onclick="editField('${userId}', 'teamName', '${fullUserData.teamName || ''}')" class="cursor-pointer hover:bg-gray-100 px-1 rounded">${fullUserData.teamName || 'Click to add team'}</span>
                        </p>
                        <p><strong>Activation Code:</strong> ${fullUserData.activationCode}</p>
                    </div>
                    <div>
                        <h4 class="font-medium text-gray-900 mb-2">${fullUserData.accountType === 'athlete' ? 'Athletic' : 'Coaching'} Information</h4>
                        ${fullUserData.accountType === 'athlete' ? `
                            <p><strong>Sport:</strong> 
                                <span onclick="editField('${userId}', 'sport', '${fullUserData.sport || ''}')" class="cursor-pointer hover:bg-gray-100 px-1 rounded">${fullUserData.sport || 'Click to add'}</span>
                            </p>
                            <p><strong>Position:</strong> 
                                <span onclick="editField('${userId}', 'position', '${fullUserData.position || ''}')" class="cursor-pointer hover:bg-gray-100 px-1 rounded">${fullUserData.position || 'Click to add'}</span>
                            </p>
                            <p><strong>Height:</strong> 
                                <span onclick="editField('${userId}', 'height', '${fullUserData.height || ''}')" class="cursor-pointer hover:bg-gray-100 px-1 rounded">${fullUserData.height || 'Click to add'}</span>
                            </p>
                            <p><strong>Weight:</strong> 
                                <span onclick="editField('${userId}', 'weight', '${fullUserData.weight || ''}')" class="cursor-pointer hover:bg-gray-100 px-1 rounded">${fullUserData.weight || 'Click to add'}</span>
                            </p>
                            <p><strong>Skill Level:</strong> 
                                <span onclick="editField('${userId}', 'skillLevel', '${fullUserData.skillLevel || ''}')" class="cursor-pointer hover:bg-gray-100 px-1 rounded">${fullUserData.skillLevel || 'Click to add'}</span>
                            </p>
                            <p><strong>Goals:</strong> 
                                <span onclick="editField('${userId}', 'goals', '${fullUserData.goals ? fullUserData.goals.join(', ') : ''}')" class="cursor-pointer hover:bg-gray-100 px-1 rounded">${fullUserData.goals ? fullUserData.goals.join(', ') : 'Click to add'}</span>
                            </p>
                        ` : `
                            <p><strong>Organization:</strong> 
                                <span onclick="editField('${userId}', 'organization', '${fullUserData.organization || ''}')" class="cursor-pointer hover:bg-gray-100 px-1 rounded">${fullUserData.organization || 'Click to add'}</span>
                            </p>
                            <p><strong>Experience:</strong> 
                                <span onclick="editField('${userId}', 'coachingExperience', '${fullUserData.coachingExperience || ''}')" class="cursor-pointer hover:bg-gray-100 px-1 rounded">${fullUserData.coachingExperience ? fullUserData.coachingExperience + ' years' : 'Click to add'}</span>
                            </p>
                        `}
                    </div>
                </div>
                
                <!-- Password Management Section -->
                <div class="mt-6 border-t pt-4">
                    <h4 class="font-medium text-gray-900 mb-3">Security & Access</h4>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between">
                            <span><strong>Password:</strong></span>
                            <div class="flex items-center space-x-2">
                                <span id="passwordDisplay">${isRootUser ? (fullUserData.password || '**********') : '**********'}</span>
                                ${isRootUser ? `
                                    <button onclick="togglePasswordVisibility('${userId}')" id="passwordToggle" class="text-blue-600 hover:text-blue-800 text-xs">
                                        ${fullUserData.password && !fullUserData.password.includes('*') ? 'Hide' : 'Show'}
                                    </button>
                                ` : '<span class="text-xs text-gray-500">(Root access required)</span>'}
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <span><strong>Account Status:</strong></span>
                            <div class="flex items-center space-x-2">
                                <span class="px-2 py-1 text-xs rounded-full ${fullUserData.isActive !== false ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                    ${fullUserData.isActive !== false ? 'Active' : 'Disabled'}
                                </span>
                                <button onclick="toggleUserStatus('${userId}')" class="bg-yellow-500 hover:bg-yellow-600 text-white px-2 py-1 rounded text-xs">
                                    ${fullUserData.isActive !== false ? 'Disable' : 'Enable'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Account Details -->
                <div class="mt-4 border-t pt-4">
                    <h4 class="font-medium text-gray-900 mb-2">Account Details</h4>
                    <p><strong>Created:</strong> ${new Date(fullUserData.createdAt).toLocaleString()}</p>
                    <p><strong>Last Updated:</strong> ${new Date(fullUserData.updatedAt || fullUserData.createdAt).toLocaleString()}</p>
                    <p><strong>User ID:</strong> ${fullUserData.id}</p>
                </div>

                <!-- Admin Actions -->
                <div class="mt-6 border-t pt-4 flex space-x-3">
                    <button onclick="changeUserPassword('${userId}')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm">
                        Change Password
                    </button>
                    <button onclick="resetUserData('${userId}')" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded text-sm">
                        Reset Profile
                    </button>
                    <button onclick="deleteUser('${userId}')" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded text-sm">
                        Delete User
                    </button>
                </div>
            `;

            document.getElementById('userModal').classList.remove('hidden');
        }
        
        // Toggle password visibility (root only)
        function togglePasswordVisibility(userId) {
            const user = allUsers.find(u => u.id === userId);
            const passwordDisplay = document.getElementById('passwordDisplay');
            const toggleButton = document.getElementById('passwordToggle');
            
            if (passwordDisplay.textContent.includes('*')) {
                // Show actual password
                const actualPassword = JSON.parse(localStorage.getItem('registeredUsers') || '[]').find(u => u.id === userId)?.password || 'password123';
                passwordDisplay.textContent = actualPassword;
                toggleButton.textContent = 'Hide';
            } else {
                // Hide password
                passwordDisplay.textContent = '**********';
                toggleButton.textContent = 'Show';
            }
        }
        
        // Toggle user active status
        function toggleUserStatus(userId) {
            const userIndex = allUsers.findIndex(u => u.id === userId);
            if (userIndex === -1) return;
            
            allUsers[userIndex].isActive = !allUsers[userIndex].isActive;
            
            // Update in storage
            const registeredUsers = JSON.parse(localStorage.getItem('registeredUsers') || '[]');
            const regUserIndex = registeredUsers.findIndex(u => u.id === userId);
            if (regUserIndex !== -1) {
                registeredUsers[regUserIndex].isActive = allUsers[userIndex].isActive;
                localStorage.setItem('registeredUsers', JSON.stringify(registeredUsers));
            }
            
            // Refresh the modal
            viewUserDetails(userId);
            
            // Show confirmation
            alert(`User ${allUsers[userIndex].isActive ? 'enabled' : 'disabled'} successfully.`);
        }
        
        // Change user password
        function changeUserPassword(userId) {
            const newPassword = prompt('Enter new password for user:');
            if (!newPassword) return;
            
            if (newPassword.length < 6) {
                alert('Password must be at least 6 characters long.');
                return;
            }
            
            // Update password in storage
            const registeredUsers = JSON.parse(localStorage.getItem('registeredUsers') || '[]');
            const userIndex = registeredUsers.findIndex(u => u.id === userId);
            if (userIndex !== -1) {
                registeredUsers[userIndex].password = newPassword;
                localStorage.setItem('registeredUsers', JSON.stringify(registeredUsers));
                alert('Password changed successfully.');
                viewUserDetails(userId); // Refresh modal
            }
        }
        
        // Reset user profile data
        function resetUserData(userId) {
            if (!confirm('Are you sure you want to reset this user\'s profile data? This action cannot be undone.')) {
                return;
            }
            
            const registeredUsers = JSON.parse(localStorage.getItem('registeredUsers') || '[]');
            const userIndex = registeredUsers.findIndex(u => u.id === userId);
            if (userIndex !== -1) {
                // Keep basic info but reset profile data
                const basicInfo = {
                    id: registeredUsers[userIndex].id,
                    firstName: registeredUsers[userIndex].firstName,
                    lastName: registeredUsers[userIndex].lastName,
                    email: registeredUsers[userIndex].email,
                    password: registeredUsers[userIndex].password,
                    accountType: registeredUsers[userIndex].accountType,
                    createdAt: registeredUsers[userIndex].createdAt,
                    isActive: registeredUsers[userIndex].isActive
                };
                registeredUsers[userIndex] = basicInfo;
                localStorage.setItem('registeredUsers', JSON.stringify(registeredUsers));
                alert('User profile data reset successfully.');
                loadUsers(); // Refresh user list
                closeUserModal();
            }
        }
        
        // Delete user
        function deleteUser(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!confirm(`Are you sure you want to permanently delete user "${user.firstName} ${user.lastName}"? This action cannot be undone.`)) {
                return;
            }
            
            // Remove from registered users
            const registeredUsers = JSON.parse(localStorage.getItem('registeredUsers') || '[]');
            const filteredUsers = registeredUsers.filter(u => u.id !== userId);
            localStorage.setItem('registeredUsers', JSON.stringify(filteredUsers));
            
            alert('User deleted successfully.');
            loadUsers(); // Refresh user list
            closeUserModal();
        }
        
        // Edit field inline
        function editField(userId, fieldName, currentValue) {
            let newValue;
            
            // Special handling for team name to show coach association
            if (fieldName === 'teamName') {
                const user = allUsers.find(u => u.id === userId);
                if (user && user.accountType === 'athlete') {
                    // Get all coaches for team selection
                    const coaches = allUsers.filter(u => u.accountType === 'coach');
                    
                    if (coaches.length > 0) {
                        let coachOptions = coaches.map(coach => 
                            `${coach.firstName} ${coach.lastName} (${coach.email})`
                        ).join('\\n');
                        
                        const selectedOption = prompt(
                            `Enter team name or select a coach to associate with:\\n\\nAvailable Coaches:\\n${coachOptions}\\n\\nEnter team name:`, 
                            currentValue || ''
                        );
                        
                        if (selectedOption === null) return; // User cancelled
                        
                        // Check if user selected a coach by email
                        const selectedCoach = coaches.find(coach => 
                            selectedOption.includes(coach.email) || 
                            selectedOption.includes(`${coach.firstName} ${coach.lastName}`)
                        );
                        
                        if (selectedCoach) {
                            newValue = `${selectedCoach.firstName}'s Team`;
                            alert(`Athlete ${user.firstName} ${user.lastName} has been assigned to ${selectedCoach.firstName} ${selectedCoach.lastName}'s team.`);
                        } else {
                            newValue = selectedOption;
                        }
                    } else {
                        newValue = prompt(`Enter team name:`, currentValue || '');
                        if (newValue === null) return;
                    }
                } else {
                    newValue = prompt(`Enter team name:`, currentValue || '');
                    if (newValue === null) return;
                }
            } else {
                newValue = prompt(`Enter new ${fieldName}:`, currentValue || '');
                if (newValue === null) return; // User cancelled
            }
            
            // Update in all storage locations
            const registeredUsers = JSON.parse(localStorage.getItem('registeredUsers') || '[]');
            const userIndex = registeredUsers.findIndex(u => u.id === userId);
            
            if (userIndex !== -1) {
                // Handle special cases
                if (fieldName === 'goals') {
                    registeredUsers[userIndex][fieldName] = newValue.split(',').map(g => g.trim()).filter(g => g);
                } else {
                    registeredUsers[userIndex][fieldName] = newValue;
                }
                
                // Update profile nested object if it exists
                if (!registeredUsers[userIndex].profile) {
                    registeredUsers[userIndex].profile = {};
                }
                registeredUsers[userIndex].profile[fieldName] = registeredUsers[userIndex][fieldName];
                
                localStorage.setItem('registeredUsers', JSON.stringify(registeredUsers));
                
                // Refresh the modal to show updated data
                viewUserDetails(userId);
                loadUsers(); // Refresh user list too
                
                alert(`${fieldName} updated successfully.`);
            }
        }

        function closeUserModal() {
            document.getElementById('userModal').classList.add('hidden');
        }

        // Initialize
        if (checkAdminAuth()) {
            const username = sessionStorage.getItem('adminUsername');
            document.getElementById('adminUsername').textContent = username;
            loadUsers();
        }
    </script>
</body>
</html>