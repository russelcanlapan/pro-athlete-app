<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Accounts - Admin - Pro Athlete</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-gray-900">User Accounts</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-600">Welcome, <span id="adminUsername">root</span></span>
                    <button onclick="logout()" class="text-sm text-red-600 hover:text-red-700">Logout</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="bg-blue-600 text-white">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex space-x-8">
                <a href="dashboard.html" class="hover:bg-blue-700 px-3 py-2 text-sm font-medium">Dashboard</a>
                <a href="users.html" class="bg-blue-700 px-3 py-2 text-sm font-medium">User Accounts</a>
                <a href="reports.html" class="hover:bg-blue-700 px-3 py-2 text-sm font-medium">Reports</a>
                <a href="videos.html" class="hover:bg-blue-700 px-3 py-2 text-sm font-medium">Video Upload</a>
                <a href="activation-codes.html" class="hover:bg-blue-700 px-3 py-2 text-sm font-medium">Activation Codes</a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <!-- Filters -->
        <div class="bg-white shadow rounded-lg mb-6">
            <div class="px-4 py-5 sm:p-6">
                <div class="flex flex-wrap gap-4 items-center">
                    <div>
                        <label for="userTypeFilter" class="block text-sm font-medium text-gray-700">Filter by Type</label>
                        <select id="userTypeFilter" onchange="filterUsers()" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                            <option value="all">All Users</option>
                            <option value="athlete">Athletes</option>
                            <option value="coach">Coaches</option>
                        </select>
                    </div>
                    <div>
                        <label for="searchInput" class="block text-sm font-medium text-gray-700">Search Users</label>
                        <input type="text" id="searchInput" onkeyup="searchUsers()" placeholder="Search by name or email..." class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>
                    <div class="flex-1"></div>
                    <div>
                        <button onclick="refreshUsers()" class="bg-blue-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-blue-700">Refresh</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Users Table -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-4 py-5 sm:p-6">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sport</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Team</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTable" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="7" class="px-6 py-4 text-center text-gray-500">Loading users...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- User Details Modal -->
    <div id="userModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-96 overflow-y-auto">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">User Details</h3>
                <button onclick="closeUserModal()" class="float-right text-gray-400 hover:text-gray-600">
                    <span class="sr-only">Close</span>
                    <span class="text-2xl">&times;</span>
                </button>
            </div>
            <div id="userModalContent" class="px-6 py-4">
                <!-- User details will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        let allUsers = [];

        // Check admin authentication
        function checkAdminAuth() {
            if (sessionStorage.getItem('adminAuthenticated') !== 'true') {
                window.location.href = 'login.html';
                return false;
            }
            return true;
        }

        function logout() {
            sessionStorage.removeItem('adminAuthenticated');
            sessionStorage.removeItem('adminUsername');
            window.location.href = 'login.html';
        }

        // Load users from localStorage
        async function loadUsers() {
            try {
                // Get all registered users from localStorage (same logic as dashboard)
                const allUserData = [];
                
                // Check for users in different storage locations
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && (key.includes('UserData') || key === 'currentUser')) {
                        try {
                            const userData = JSON.parse(localStorage.getItem(key));
                            if (userData && userData.email && userData.accountType) {
                                // Make sure we have proper user data structure
                                const normalizedUser = {
                                    id: userData.id || key,
                                    firstName: userData.firstName || 'Unknown',
                                    lastName: userData.lastName || 'User',
                                    email: userData.email,
                                    accountType: userData.accountType,
                                    createdAt: userData.createdAt || new Date().toISOString(),
                                    updatedAt: userData.updatedAt || new Date().toISOString(),
                                    isActive: userData.isActive !== false,
                                    activationCode: userData.activationCode || 'N/A',
                                    // Additional fields for user details
                                    phone: userData.phone || '',
                                    dateOfBirth: userData.dateOfBirth || '',
                                    sport: userData.sport || '',
                                    position: userData.position || '',
                                    height: userData.height || '',
                                    weight: userData.weight || '',
                                    skillLevel: userData.skillLevel || '',
                                    teamName: userData.teamName || '',
                                    organization: userData.organization || '',
                                    coachingExperience: userData.coachingExperience || ''
                                };
                                allUserData.push(normalizedUser);
                            }
                        } catch (e) {
                            // Skip invalid data
                            console.log('Skipping invalid user data:', key, e);
                        }
                    }
                }

                // Remove duplicates based on email
                allUsers = allUserData.filter((user, index, self) => 
                    index === self.findIndex(u => u.email === user.email)
                );

                console.log('Loaded users for admin panel:', allUsers);
                displayUsers(allUsers);
            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('usersTable').innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-red-500">Error loading users</td></tr>';
            }
        }

        function displayUsers(users) {
            const usersTable = document.getElementById('usersTable');
            
            if (users.length === 0) {
                usersTable.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">No users found</td></tr>';
                return;
            }

            usersTable.innerHTML = users.map(user => `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${user.firstName} ${user.lastName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.email}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${user.accountType === 'athlete' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}">
                            ${user.accountType}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.sport || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.teamName || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(user.createdAt).toLocaleDateString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="viewUserDetails('${user.id}')" class="text-blue-600 hover:text-blue-900">View Details</button>
                    </td>
                </tr>
            `).join('');
        }

        function filterUsers() {
            const filterType = document.getElementById('userTypeFilter').value;
            let filteredUsers = allUsers;

            if (filterType !== 'all') {
                filteredUsers = allUsers.filter(user => user.accountType === filterType);
            }

            displayUsers(filteredUsers);
        }

        function searchUsers() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filteredUsers = allUsers.filter(user => 
                user.firstName.toLowerCase().includes(searchTerm) ||
                user.lastName.toLowerCase().includes(searchTerm) ||
                user.email.toLowerCase().includes(searchTerm)
            );

            displayUsers(filteredUsers);
        }

        function refreshUsers() {
            loadUsers();
        }

        function viewUserDetails(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;

            // Get detailed profile information from signup data
            const profileData = user.profile || {};
            const signupData = JSON.parse(localStorage.getItem('registeredUsers') || '[]').find(u => u.email === user.email) || {};
            
            // Merge all available data
            const fullUserData = { ...user, ...profileData, ...signupData };
            
            const currentAdmin = sessionStorage.getItem('adminUsername');
            const isRootUser = currentAdmin === 'root';

            const modalContent = document.getElementById('userModalContent');
            modalContent.innerHTML = `
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <h4 class="font-medium text-gray-900 mb-2">Basic Information</h4>
                        <p><strong>Name:</strong> ${fullUserData.firstName} ${fullUserData.lastName}</p>
                        <p><strong>Email:</strong> ${fullUserData.email}</p>
                        <p><strong>Account Type:</strong> ${fullUserData.accountType || fullUserData.userType}</p>
                        <p><strong>Phone:</strong> ${fullUserData.phone || 'N/A'}</p>
                        <p><strong>Date of Birth:</strong> ${fullUserData.dateOfBirth || 'N/A'}</p>
                        <p><strong>Activation Code:</strong> ${fullUserData.activationCode || 'N/A'}</p>
                    </div>
                    <div>
                        <h4 class="font-medium text-gray-900 mb-2">${fullUserData.accountType === 'athlete' ? 'Athletic' : 'Coaching'} Information</h4>
                        ${fullUserData.accountType === 'athlete' ? `
                            <p><strong>Sport:</strong> ${fullUserData.sport || 'N/A'}</p>
                            <p><strong>Position:</strong> ${fullUserData.position || 'N/A'}</p>
                            <p><strong>Height:</strong> ${fullUserData.height || 'N/A'}</p>
                            <p><strong>Weight:</strong> ${fullUserData.weight || 'N/A'}</p>
                            <p><strong>Skill Level:</strong> ${fullUserData.skillLevel || 'N/A'}</p>
                            <p><strong>Team:</strong> ${fullUserData.teamName || 'N/A'}</p>
                            <p><strong>Goals:</strong> ${fullUserData.goals ? fullUserData.goals.join(', ') : 'N/A'}</p>
                        ` : `
                            <p><strong>Organization:</strong> ${fullUserData.organization || 'N/A'}</p>
                            <p><strong>Experience:</strong> ${fullUserData.coachingExperience ? fullUserData.coachingExperience + ' years' : 'N/A'}</p>
                            <p><strong>Teams Managed:</strong> ${fullUserData.teamsManaged ? fullUserData.teamsManaged.length : 0}</p>
                        `}
                    </div>
                </div>
                
                <!-- Password Management Section -->
                <div class="mt-6 border-t pt-4">
                    <h4 class="font-medium text-gray-900 mb-3">Security & Access</h4>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between">
                            <span><strong>Password:</strong></span>
                            <div class="flex items-center space-x-2">
                                <span id="passwordDisplay">${isRootUser ? (fullUserData.password || '**********') : '**********'}</span>
                                ${isRootUser ? `
                                    <button onclick="togglePasswordVisibility('${userId}')" id="passwordToggle" class="text-blue-600 hover:text-blue-800 text-xs">
                                        ${fullUserData.password && !fullUserData.password.includes('*') ? 'Hide' : 'Show'}
                                    </button>
                                ` : '<span class="text-xs text-gray-500">(Root access required)</span>'}
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <span><strong>Account Status:</strong></span>
                            <div class="flex items-center space-x-2">
                                <span class="px-2 py-1 text-xs rounded-full ${fullUserData.isActive !== false ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                    ${fullUserData.isActive !== false ? 'Active' : 'Disabled'}
                                </span>
                                <button onclick="toggleUserStatus('${userId}')" class="bg-yellow-500 hover:bg-yellow-600 text-white px-2 py-1 rounded text-xs">
                                    ${fullUserData.isActive !== false ? 'Disable' : 'Enable'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Account Details -->
                <div class="mt-4 border-t pt-4">
                    <h4 class="font-medium text-gray-900 mb-2">Account Details</h4>
                    <p><strong>Created:</strong> ${new Date(fullUserData.createdAt).toLocaleString()}</p>
                    <p><strong>Last Updated:</strong> ${new Date(fullUserData.updatedAt || fullUserData.createdAt).toLocaleString()}</p>
                    <p><strong>User ID:</strong> ${fullUserData.id}</p>
                </div>

                <!-- Admin Actions -->
                <div class="mt-6 border-t pt-4 flex space-x-3">
                    <button onclick="changeUserPassword('${userId}')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm">
                        Change Password
                    </button>
                    <button onclick="resetUserData('${userId}')" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded text-sm">
                        Reset Profile
                    </button>
                    <button onclick="deleteUser('${userId}')" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded text-sm">
                        Delete User
                    </button>
                </div>
            `;

            document.getElementById('userModal').classList.remove('hidden');
        }
        
        // Toggle password visibility (root only)
        function togglePasswordVisibility(userId) {
            const user = allUsers.find(u => u.id === userId);
            const passwordDisplay = document.getElementById('passwordDisplay');
            const toggleButton = document.getElementById('passwordToggle');
            
            if (passwordDisplay.textContent.includes('*')) {
                // Show actual password
                const actualPassword = JSON.parse(localStorage.getItem('registeredUsers') || '[]').find(u => u.id === userId)?.password || 'password123';
                passwordDisplay.textContent = actualPassword;
                toggleButton.textContent = 'Hide';
            } else {
                // Hide password
                passwordDisplay.textContent = '**********';
                toggleButton.textContent = 'Show';
            }
        }
        
        // Toggle user active status
        function toggleUserStatus(userId) {
            const userIndex = allUsers.findIndex(u => u.id === userId);
            if (userIndex === -1) return;
            
            allUsers[userIndex].isActive = !allUsers[userIndex].isActive;
            
            // Update in storage
            const registeredUsers = JSON.parse(localStorage.getItem('registeredUsers') || '[]');
            const regUserIndex = registeredUsers.findIndex(u => u.id === userId);
            if (regUserIndex !== -1) {
                registeredUsers[regUserIndex].isActive = allUsers[userIndex].isActive;
                localStorage.setItem('registeredUsers', JSON.stringify(registeredUsers));
            }
            
            // Refresh the modal
            viewUserDetails(userId);
            
            // Show confirmation
            alert(`User ${allUsers[userIndex].isActive ? 'enabled' : 'disabled'} successfully.`);
        }
        
        // Change user password
        function changeUserPassword(userId) {
            const newPassword = prompt('Enter new password for user:');
            if (!newPassword) return;
            
            if (newPassword.length < 6) {
                alert('Password must be at least 6 characters long.');
                return;
            }
            
            // Update password in storage
            const registeredUsers = JSON.parse(localStorage.getItem('registeredUsers') || '[]');
            const userIndex = registeredUsers.findIndex(u => u.id === userId);
            if (userIndex !== -1) {
                registeredUsers[userIndex].password = newPassword;
                localStorage.setItem('registeredUsers', JSON.stringify(registeredUsers));
                alert('Password changed successfully.');
                viewUserDetails(userId); // Refresh modal
            }
        }
        
        // Reset user profile data
        function resetUserData(userId) {
            if (!confirm('Are you sure you want to reset this user\'s profile data? This action cannot be undone.')) {
                return;
            }
            
            const registeredUsers = JSON.parse(localStorage.getItem('registeredUsers') || '[]');
            const userIndex = registeredUsers.findIndex(u => u.id === userId);
            if (userIndex !== -1) {
                // Keep basic info but reset profile data
                const basicInfo = {
                    id: registeredUsers[userIndex].id,
                    firstName: registeredUsers[userIndex].firstName,
                    lastName: registeredUsers[userIndex].lastName,
                    email: registeredUsers[userIndex].email,
                    password: registeredUsers[userIndex].password,
                    accountType: registeredUsers[userIndex].accountType,
                    createdAt: registeredUsers[userIndex].createdAt,
                    isActive: registeredUsers[userIndex].isActive
                };
                registeredUsers[userIndex] = basicInfo;
                localStorage.setItem('registeredUsers', JSON.stringify(registeredUsers));
                alert('User profile data reset successfully.');
                loadUsers(); // Refresh user list
                closeUserModal();
            }
        }
        
        // Delete user
        function deleteUser(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!confirm(`Are you sure you want to permanently delete user "${user.firstName} ${user.lastName}"? This action cannot be undone.`)) {
                return;
            }
            
            // Remove from registered users
            const registeredUsers = JSON.parse(localStorage.getItem('registeredUsers') || '[]');
            const filteredUsers = registeredUsers.filter(u => u.id !== userId);
            localStorage.setItem('registeredUsers', JSON.stringify(filteredUsers));
            
            alert('User deleted successfully.');
            loadUsers(); // Refresh user list
            closeUserModal();
        }

        function closeUserModal() {
            document.getElementById('userModal').classList.add('hidden');
        }

        // Initialize
        if (checkAdminAuth()) {
            const username = sessionStorage.getItem('adminUsername');
            document.getElementById('adminUsername').textContent = username;
            loadUsers();
        }
    </script>
</body>
</html>